#!/usr/bin/env th
local lapp = require 'pl.lapp'

local path = require 'pl.path'

dofile("luasrc/parse.lua") -- TODO require
dofile("luasrc/markdown.lua")-- TODO require

-- TODO debug mode
require 'logging.console'
local logger = logging.console()
logger:setLevel(logging.DEBUG)

local function processArgs()
    return  lapp [[
    Extract inline documentation from Lua source
    -o,--output (string)    output directory
    <inputs...>  (string)    input .lua files
    ]]
end


local function main()
    local args = processArgs()

    for i, input in ipairs(args.inputs) do
        logger:info("Processing file " .. input)

        local basename = path.basename(input)
        local packageName, ext = path.splitext(basename)
        lapp.assert(ext == '.lua', "Expected .lua file for input")
        local outputPath = path.join(args.output, packageName .. ".md")

        local documentedFunctions = dokx.extractDocs(input)

        -- Output markdown
        local writer = MarkdownWriter(outputPath, packageName)
        local function handleEntity(entity)
            writer:documentEntity(entity)
        end
        documentedFunctions:foreach(handleEntity)
        writer:close()
    end
end

main()

