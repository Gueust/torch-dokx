#!/usr/bin/env th

local lapp = require 'pl.lapp'
local path = require 'pl.path'
require 'logging.console'
local logger = logging.console()
logger:setLevel(logging.DEBUG)

local function processArgs()
    return lapp [[
Build HTML documentation from Markdown files.
   -o,--output (string) output directory
   <inputs...> (string) input .md files
]]
end

function readFile(inputPath)
    lapp.assert(path.isfile(inputPath), "Not a file: " .. tostring(inputPath))
    logger:debug("Opening " .. tostring(inputPath))
    local inputFile = io.open(inputPath, "rb")
    lapp.assert(inputFile, "Could not open: " .. tostring(inputPath))
    local content = inputFile:read("*all")
    inputFile:close()
    return content
end

local function handleFile(markdownFile, outputPath)
    local sundown = require 'sundown'
    local content = readFile(markdownFile)
    local rendered = sundown.render(content)
    local outputFile = io.open(outputPath, 'w')
    logger:debug("Writing to " .. outputPath)
    lapp.assert(outputFile, "Could not open: " .. outputPath)
    outputFile:write(rendered)
    outputFile:close()
end

local function main(args)
    if not path.isdir(args.output) then
        logger:info("Directory " .. args.output .. " not found; creating it.")
        path.mkdir(args.output)
    end

    for i, input in ipairs(args.inputs) do
        logger:info("Processing file " .. input)
        local basename = path.basename(input)
        local packageName, ext = path.splitext(basename)
        lapp.assert(ext == '.md', "Expected .md file for input")
        local outputPath = path.join(args.output, packageName .. ".html")

        handleFile(input, outputPath)
    end
end

main(processArgs())
